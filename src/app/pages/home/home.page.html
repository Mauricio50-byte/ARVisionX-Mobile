<ion-header [translucent]="true">
  <ion-toolbar>
    <app-header-actions [title]="'Panel de Targets'" [displayName]="displayName || 'Usuario'"></app-header-actions>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" id="home-content">
  <div class="container py-4">
    <div class="row g-4">
      <div class="col-12 col-lg-6">
        <div class="card shadow border-0 rounded-4">
          <div class="card-header bg-white border-0 py-3">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <h5 class="mb-0">Editor de Target</h5>
                <small class="text-muted">Completa los datos y guarda</small>
              </div>
              <button class="btn btn-outline-primary btn-sm" (click)="openImportJson()">
                <i class="bi bi-download me-1"></i> Importar desde JSON
              </button>
            </div>
          </div>
          <div class="card-body">
            <form [formGroup]="form" (ngSubmit)="saveTarget()" class="row g-3">
              <div class="col-12">
                <ion-item>
                  <ion-label position="stacked">Nombre</ion-label>
                  <ion-input formControlName="name" placeholder="Ej: Logo AR"></ion-input>
                </ion-item>
                <ion-note color="danger" *ngIf="form.controls.name.invalid && form.controls.name.touched">Requerido</ion-note>
              </div>

              <div class="col-12">
                <ion-item>
                  <ion-label position="stacked">Tipo</ion-label>
                  <ion-segment formControlName="type">
                    <ion-segment-button value="preset">Preset</ion-segment-button>
                    <ion-segment-button value="pattern">Pattern</ion-segment-button>
                  </ion-segment>
                </ion-item>
              </div>

              <div class="col-12">
                <ng-container *ngIf="form.value.type === 'preset'; else patternUrlBlock">
                  <ion-item>
                    <ion-label position="stacked">Preset</ion-label>
                    <ion-select [value]="selectedPreset" interface="popover" (ionChange)="onPresetChange($event)">
                      <ion-select-option *ngFor="let p of presets" [value]="p">{{p}}</ion-select-option>
                    </ion-select>
                  </ion-item>
                </ng-container>
                <ng-template #patternUrlBlock>
                  <ion-item>
                    <ion-label position="stacked">Pattern/URL</ion-label>
                    <ion-input formControlName="pattern" placeholder="URL .patt/.mind o .png/.jpg"></ion-input>
                  </ion-item>
                  <div class="mt-2 d-flex gap-2">
                    <ion-button size="small" [disabled]="uploadingPattern" (click)="patternInput.click()">
                      {{ uploadingPattern ? 'Subiendo...' : 'Subir Pattern' }}
                    </ion-button>
                    <input #patternInput type="file" hidden accept=".patt,.mind,.png,.jpg,.jpeg" (change)="onPatternSelected($event)" />
                  </div>
                </ng-template>
              </div>

              <div class="col-12">
                <ion-item>
                  <ion-label position="stacked">Model URL</ion-label>
                  <ion-input formControlName="modelUrl" placeholder="URL .glb/.gltf/.obj/.dae o .png/.jpg/.webp/.svg"></ion-input>
                </ion-item>
                <div class="mt-2 d-flex gap-2">
                  <ion-button size="small" [disabled]="uploadingModel" (click)="modelInput.click()">
                    {{ uploadingModel ? 'Subiendo...' : 'Subir Modelo' }}
                  </ion-button>
                  <input #modelInput type="file" hidden accept=".glb,.gltf,.obj,.dae,.png,.jpg,.jpeg,.webp,.svg" (change)="onModelSelected($event)" />
                </div>
              </div>

              <div class="col-12">
                <ion-item>
                  <ion-label position="stacked">Scale</ion-label>
                  <ion-input formControlName="scale" placeholder="0.5 0.5 0.5"></ion-input>
                </ion-item>
              </div>

              <div class="col-12">
                <div class="d-flex gap-2 mt-2">
                  <button type="submit" class="btn btn-primary" [disabled]="form.invalid || saving">
                    <i class="bi bi-save me-1"></i>
                    <span *ngIf="!saving">Guardar</span>
                    <span *ngIf="saving" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                  </button>
                  <button type="button" class="btn btn-outline-secondary" (click)="newTarget()">
                    <i class="bi bi-plus-lg me-1"></i>
                    Nuevo Target
                  </button>
                  <button type="button" class="btn btn-outline-primary" (click)="openTargets()">
                    <i class="bi bi-list me-1"></i>
                    Consultar Targets
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  <ion-modal [isOpen]="openTargetsModal" (didDismiss)="openTargetsModal=false" style="--width: 720px; --max-width: 95vw; --height: auto; --border-radius: 16px;">
    <ng-template>
      <div class="p-3">
        <div class="card shadow border-0 rounded-4">
          <app-targets-table [items]="targets" (edit)="onTableEdit($event)" (remove)="onTableDelete($event)" (dismiss)="openTargetsModal=false"></app-targets-table>
        </div>
      </div>
    </ng-template>
  </ion-modal>
  <ion-modal [isOpen]="openImportModal" (didDismiss)="openImportModal=false" style="--width: 720px; --max-width: 95vw; --height: auto; --border-radius: 16px;">
    <ng-template>
      <div class="p-3">
        <div class="card shadow border-0 rounded-4">
          <app-import-json (closed)="openImportModal=false"></app-import-json>
        </div>
      </div>
    </ng-template>
  </ion-modal>
</ion-content>
<ion-menu contentId="home-content" menuId="main-menu" type="overlay" style="--width: 100vw;">
  <ion-header>
    <ion-toolbar>
      <ion-title>Menú</ion-title>
      <ion-buttons slot="end">
        <ion-menu-toggle>
          <ion-button aria-label="Cerrar menú">
            <ion-icon name="close-outline"></ion-icon>
          </ion-button>
        </ion-menu-toggle>
      </ion-buttons>
    </ion-toolbar>
  </ion-header>
  <ion-content class="ion-padding">
    <ion-list>
      <ion-menu-toggle>
        <ion-item button detail="false" (click)="openProfileFromMenu()">
          <ion-icon name="person-circle-outline" slot="start"></ion-icon>
          <ion-label>Perfil</ion-label>
        </ion-item>
      </ion-menu-toggle>
      <ion-menu-toggle>
        <ion-item button detail="false" (click)="navigateArFromMenu()">
          <ion-icon name="cube-outline" slot="start"></ion-icon>
          <ion-label>AR</ion-label>
        </ion-item>
      </ion-menu-toggle>
      <ion-menu-toggle>
        <ion-item button color="danger" detail="false" (click)="logoutFromMenu()">
          <ion-icon name="log-out-outline" slot="start"></ion-icon>
          <ion-label>Cerrar sesión</ion-label>
        </ion-item>
      </ion-menu-toggle>
    </ion-list>
  </ion-content>
  
</ion-menu>
