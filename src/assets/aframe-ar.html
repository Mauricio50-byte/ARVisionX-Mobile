<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>AFRAME AR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      html, body { height: 100%; }
      body { margin: 0; overflow: hidden; background: #000; }
      a-scene { position: absolute; inset: 0; }
      #arjs-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; background: #000; }
      .perm-overlay { position: absolute; z-index: 20; top: 12px; left: 0; right: 0; display: none; justify-content: center; }
      .perm-banner { background: rgba(0,0,0,.6); color: #fff; padding: 8px 12px; border-radius: 12px; font: 14px system-ui; display: flex; gap: 8px; align-items: center; }
    </style>
  </head>
  <body>
    <a-scene
      embedded
      renderer="logarithmicDepthBuffer: true; antialias: true; precision: highp;"
      arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; sourceWidth: 1920; sourceHeight: 1080; displayWidth: 1920; displayHeight: 1080;"
    >
      <a-entity camera></a-entity>
    </a-scene>
    <div class="perm-overlay" id="perm">
      <div class="perm-banner">
        <span>Necesita permiso de cámara</span>
        <button id="permBtn">Permitir cámara</button>
      </div>
    </div>
    <script>
      (function(){
        const scene = document.querySelector('a-scene');
        let currentMarker = null;
        function clearMarker(){
          if (currentMarker && scene) {
            try { scene.removeChild(currentMarker); } catch(e){}
            currentMarker = null;
          }
        }
        function applyTarget(target){
          if (!scene || !target) return;
          clearMarker();
          const type = (target.type || 'preset');
          const pattern = (target.pattern || '').trim();
          let marker;
          if (type === 'preset') {
            marker = document.createElement('a-marker');
            marker.setAttribute('preset', pattern || 'hiro');
          } else {
            const lower = pattern.toLowerCase();
            if (lower.endsWith('.patt') || lower.endsWith('.mind')) {
              marker = document.createElement('a-marker');
              marker.setAttribute('type', 'pattern');
              marker.setAttribute('url', pattern);
            } else {
              const base = pattern.replace(/\.(png|jpg|jpeg|webp|svg)$/i, '');
              marker = document.createElement('a-nft');
              marker.setAttribute('type', 'nft');
              marker.setAttribute('url', base);
              marker.setAttribute('smooth', 'true');
              marker.setAttribute('smoothCount', '10');
              marker.setAttribute('smoothTolerance', '.01');
              marker.setAttribute('smoothThreshold', '5');
            }
          }

          const modelUrl = (target.modelUrl || '').trim();
          const scale = (target.scale || '1 1 1');
          const lowerModel = modelUrl.toLowerCase();
          let content;
          if (lowerModel.endsWith('.gltf') || lowerModel.endsWith('.glb')) {
            content = document.createElement('a-entity');
            content.setAttribute('gltf-model', modelUrl);
            content.setAttribute('scale', scale);
            content.setAttribute('position', '0 0 0');
          } else if (/(\.png|\.jpg|\.jpeg|\.webp|\.svg)$/.test(lowerModel)) {
            content = document.createElement('a-image');
            content.setAttribute('src', modelUrl);
            content.setAttribute('scale', scale);
            content.setAttribute('position', '0 0 0');
          } else {
            content = document.createElement('a-entity');
            content.setAttribute('scale', scale);
            content.setAttribute('position', '0 0 0');
          }

          content.setAttribute('visible', 'false');
          marker.appendChild(content);
          marker.addEventListener('arjs-nft-loaded', function(){ console.log('NFT loaded'); });
          marker.addEventListener('markerFound', function(){ try { content.setAttribute('visible', 'true'); } catch(e){} });
          marker.addEventListener('markerLost', function(){ try { content.setAttribute('visible', 'false'); } catch(e){} });
          scene.appendChild(marker);
          currentMarker = marker;
        }

        window.addEventListener('message', function(ev){
          try {
            if (ev.origin !== window.location.origin) return;
            const { type, payload } = ev.data || {};
            if (type === 'SET_TARGET') applyTarget(payload);
          } catch(e){}
        });

        async function requestCamera(){
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: { ideal: 'environment' }, 
                width: { min: 1280, ideal: 1920 }, 
                height: { min: 720, ideal: 1080 },
                advanced: [{ width: 1920, height: 1080 }]
              }
            });
            stream.getTracks().forEach(t=>t.stop());
            const ov = document.getElementById('perm');
            if (ov) ov.style.display = 'none';
          } catch(e){
            const ov = document.getElementById('perm');
            if (ov) ov.style.display = 'flex';
          }
        }
        document.addEventListener('DOMContentLoaded', requestCamera);
        const btn = document.getElementById('permBtn');
        if (btn) btn.addEventListener('click', requestCamera);
      })();
    </script>
  </body>
  </html>
