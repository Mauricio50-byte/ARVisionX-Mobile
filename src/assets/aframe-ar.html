<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
    <title>AFRAME AR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      html, body { height: 100%; }
      body { margin: 0; overflow: hidden; background: #000; }
      a-scene { position: absolute; inset: 0; }
      #arjs-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: contain; background: #000; }
      .perm-overlay { position: absolute; z-index: 20; top: 12px; left: 0; right: 0; display: none; justify-content: center; }
      .perm-banner { background: rgba(0,0,0,.6); color: #fff; padding: 8px 12px; border-radius: 12px; font: 14px system-ui; display: flex; gap: 8px; align-items: center; }
    </style>
  </head>
  <body>
    <a-scene
      embedded
      renderer="logarithmicDepthBuffer: true; antialias: true; precision: highp; alpha: true; colorManagement: true;"
      arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; sourceWidth: 1920; sourceHeight: 1080; displayWidth: 1920; displayHeight: 1080;"
    >
      <a-entity camera></a-entity>
    </a-scene>
    <div class="perm-overlay" id="perm">
      <div class="perm-banner">
        <span>Necesita permiso de cámara</span>
        <button id="permBtn">Permitir cámara</button>
      </div>
    </div>
    <script>
      (function(){
        const scene = document.querySelector('a-scene');
        let currentMarker = null;
        if (scene) {
          scene.addEventListener('loaded', function(){ console.log('A-Frame scene loaded'); });
          scene.addEventListener('renderstart', function(){ console.log('Renderer started'); });
        }

        function isValidUrl(u){
          try {
            if (!u || typeof u !== 'string' || !u.trim()) return false;
            new URL(u, window.location.href);
            return true;
          } catch { return false; }
        }

        function isLikelyUrl(u){
          if (!u || typeof u !== 'string') return false;
          const s = u.trim();
          if (!s) return false;
          if (isValidUrl(s)) return true;
          if (s.startsWith('/')) return true;
          if (s.includes('/')) return true;
          return false;
        }
        function clearMarker(){
          if (currentMarker && scene) {
            try { scene.removeChild(currentMarker); } catch(e){}
            currentMarker = null;
          }
        }
        async function applyTarget(target){
          if (!scene || !target) return;
          clearMarker();
          const type = (target.type || 'preset');
          const pattern = (target.pattern || '').trim();
          let marker;
          if (type === 'preset') {
            marker = document.createElement('a-marker');
            const preset = (pattern === 'hiro' || pattern === 'kanji') ? pattern : 'hiro';
            marker.setAttribute('preset', preset);
          } else {
            const lower = pattern.toLowerCase();
            const simpleToken = /^[a-z0-9_-]+$/i.test(pattern);
            if ((lower.endsWith('.patt') || lower.endsWith('.mind')) && isLikelyUrl(pattern)) {
              if (isValidUrl(pattern)) { try { await fetch(pattern, { method: 'HEAD' }); } catch(e) { console.warn('Pattern unreachable:', pattern); } }
              marker = document.createElement('a-marker');
              marker.setAttribute('type', 'pattern');
              marker.setAttribute('url', pattern);
            } else if (pattern && !simpleToken && isLikelyUrl(pattern)) {
              const base = pattern.replace(/\.(png|jpg|jpeg|webp|svg)$/i, '');
              marker = document.createElement('a-nft');
              marker.setAttribute('type', 'nft');
              marker.setAttribute('url', base);
              marker.setAttribute('smooth', 'true');
              marker.setAttribute('smoothCount', '10');
              marker.setAttribute('smoothTolerance', '.01');
              marker.setAttribute('smoothThreshold', '5');
            } else {
              marker = document.createElement('a-marker');
              marker.setAttribute('preset', 'hiro');
            }
          }

          const modelUrl = (target.modelUrl || '').trim();
          const scale = (target.scale || '1 1 1');
          const lowerModel = modelUrl.toLowerCase();
          let content;
          if ((lowerModel.endsWith('.gltf') || lowerModel.endsWith('.glb')) && isLikelyUrl(modelUrl)) {
            if (isValidUrl(modelUrl)) { try { await fetch(modelUrl, { method: 'HEAD' }); } catch(e) { console.warn('Model unreachable:', modelUrl); } }
            content = document.createElement('a-entity');
            content.setAttribute('gltf-model', modelUrl);
            content.setAttribute('crossorigin', 'anonymous');
            content.setAttribute('scale', scale);
            content.setAttribute('position', '0 0 0');
          } else if (/(\.png|\.jpg|\.jpeg|\.webp|\.svg)$/.test(lowerModel) && isLikelyUrl(modelUrl)) {
            if (isValidUrl(modelUrl)) { try { await fetch(modelUrl, { method: 'HEAD' }); } catch(e) { console.warn('Image unreachable:', modelUrl); } }
            content = document.createElement('a-image');
            content.setAttribute('src', modelUrl);
            content.setAttribute('crossorigin', 'anonymous');
            content.setAttribute('scale', scale);
            content.setAttribute('position', '0 0 0');
          } else if (modelUrl) {
            content = document.createElement('a-entity');
            content.setAttribute('scale', scale);
            content.setAttribute('position', '0 0 0');
          } else {
            content = document.createElement('a-text');
            content.setAttribute('value', 'Asset inválido');
            content.setAttribute('color', '#FF3B30');
            content.setAttribute('scale', '1 1 1');
            content.setAttribute('position', '0 0 0');
          }

          content.setAttribute('visible', 'false');
          marker.appendChild(content);
          marker.addEventListener('arjs-nft-loaded', function(){ console.log('NFT loaded'); });
          const show = function(){ try { content.setAttribute('visible', 'true'); } catch(e){} };
          const hide = function(){ try { content.setAttribute('visible', 'false'); } catch(e){} };
          marker.addEventListener('markerFound', show);
          marker.addEventListener('markerLost', hide);
          marker.addEventListener('nftFound', show);
          marker.addEventListener('nftLost', hide);
          content.addEventListener('model-loaded', function(){ console.log('Model loaded:', modelUrl); });
          content.addEventListener('model-error', function(ev){ console.error('Model error:', modelUrl, ev.detail || ev); });
          content.addEventListener('materialtextureloaded', function(){ console.log('Texture loaded'); });
          content.addEventListener('image-loaded', function(){ console.log('Image loaded:', modelUrl); });
          scene.appendChild(marker);
          currentMarker = marker;
        }

        window.addEventListener('message', function(ev){
          try {
            const { type, payload } = ev.data || {};
            if (type === 'SET_TARGET') applyTarget(payload);
          } catch(e){}
        });

        async function requestCamera(){
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
              video: { 
                facingMode: { ideal: 'environment' }, 
                width: { min: 1280, ideal: 1920 }, 
                height: { min: 720, ideal: 1080 },
                advanced: [{ width: 1920, height: 1080 }]
              }
            });
            stream.getTracks().forEach(t=>t.stop());
            const ov = document.getElementById('perm');
            if (ov) ov.style.display = 'none';
          } catch(e){
            const ov = document.getElementById('perm');
            if (ov) ov.style.display = 'flex';
          }
        }
        document.addEventListener('DOMContentLoaded', requestCamera);
        const btn = document.getElementById('permBtn');
        if (btn) btn.addEventListener('click', requestCamera);
      })();
    </script>
  </body>
  </html>
